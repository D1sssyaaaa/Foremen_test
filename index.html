<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–¥–∞—á–∞ –¢–∞–±–µ–ª—è (Wizard V3.1)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #222);
            --hint-color: var(--tg-theme-hint-color, #999);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
        }

        h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 16px;
            text-transform: uppercase;
            color: var(--hint-color);
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--hint-color);
        }

        /* Select & Inputs */
        select,
        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--hint-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 12px;
        }

        /* Steps UI */
        .step {
            display: none;
            /* Hidden by default */
        }

        .step.active {
            display: block;
        }

        /* Workers List */
        .workers-list {
            margin-bottom: 16px;
        }

        .worker-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--secondary-bg-color);
            border-radius: 12px;
            margin-bottom: 8px;
            transition: opacity 0.2s;
        }

        .worker-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            accent-color: var(--button-color);
            cursor: pointer;
        }

        .worker-info {
            flex-grow: 1;
        }

        .worker-name {
            font-weight: 600;
            font-size: 15px;
        }

        .hours-input {
            width: 60px !important;
            padding: 8px !important;
            margin-bottom: 0 !important;
            text-align: center;
            font-weight: bold;
        }

        .add-worker-form {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .add-worker-form button {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            border-radius: 12px;
            padding: 0 16px;
            font-weight: 600;
            cursor: pointer;
            font-size: 20px;
        }

        .remove-btn {
            color: #ff3b30;
            margin-left: 10px;
            font-size: 20px;
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
        }

        /* Navigation Buttons (In-App) */
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--button-color);
            color: var(--button-text-color);
        }

        .btn-secondary {
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
        }

        .hint {
            font-size: 12px;
            color: var(--hint-color);
            margin-bottom: 8px;
        }

        .date-display {
            font-size: 20px;
            font-weight: bold;
            color: var(--button-color);
            text-align: center;
            margin: 10px 0;
            padding: 10px;
            background: var(--secondary-bg-color);
            border-radius: 12px;
        }
    </style>
</head>

<body>

    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <!-- STEP 1: SETUP -->
    <div id="step-setup" class="step">
        <h3>1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>

        <label>–û–±—ä–µ–∫—Ç</label>
        <select id="objectSelect">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</option>
        </select>

        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ—Ç—á–µ—Ç–∞</label>
        <input type="date" id="startDate">
        <div class="hint">–£–∫–∞–∂–∏—Ç–µ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫). –î–∞–ª—å—à–µ –º—ã –±—É–¥–µ–º –ª–∏—Å—Ç–∞—Ç—å –¥–Ω–∏ –≤–ø–µ—Ä–µ–¥.</div>

        <button class="btn btn-primary" style="width: 100%" onclick="goToDailyEntry()">–ù–∞—á–∞—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</button>
    </div>

    <!-- STEP 2: DAILY ENTRY -->
    <div id="step-daily" class="step">
        <h3 id="currentDateHeader">–î–∞—Ç–∞...</h3>
        <div id="currentDateDisplay" class="date-display">01.01.2026</div>

        <div id="workersList" class="workers-list">
            <!-- Workers here -->
        </div>

        <div class="add-worker-form">
            <input type="text" id="newWorkerName" placeholder="–ù–æ–≤—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫..." style="margin-bottom: 0;">
            <button onclick="addWorker()">+</button>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-primary" onclick="nextDay()">–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å &gt;</button>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-secondary" style="background-color: #34c759; color: white;"
                onclick="finishAndSend()">–ì–æ—Ç–æ–≤–æ! –û—Ç–ø—Ä–∞–≤–∏—Ç—å &gt;</button>
        </div>

        <div style="height: 50px;"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // State
        let workers = [];     // Current list of workers on screen
        let savedEntries = []; // Array of {date, workers: []} to submit
        let cursorDate = new Date(); // Current date being edited

        function init() {
            // Theme setup
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.backgroundColor || '#fff');

            // Load Workers (persistently)
            workers = JSON.parse(localStorage.getItem('my_workers_v3')) || [];
            if (workers.length === 0) {
                // Initialize defaults
                workers = [{ id: 'me', name: '–Ø (–ë—Ä–∏–≥–∞–¥–∏—Ä)', selected: true, hours: 8 }];
            }

            // Setup Start Date (Default Today)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;

            // Load Objects
            const urlParams = new URLSearchParams(window.location.search);
            const objectsRaw = urlParams.get('objects'); // Format: "Obj1,Obj2"
            const objectSelect = document.getElementById('objectSelect');

            if (objectsRaw) {
                const list = objectsRaw.split(',').map(s => s.trim());
                list.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o;
                    opt.innerText = o;
                    objectSelect.appendChild(opt);
                });
                if (list.length > 0) objectSelect.selectedIndex = 0;
            } else {
                objectSelect.innerHTML = '<option>–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤</option>';
            }

            // Show Setup Step
            document.getElementById('loader').style.display = 'none';
            document.getElementById('step-setup').classList.add('active');

            // Hide TG Main Button (we use custom buttons)
            tg.MainButton.hide();
        }

        // --- NAVIGATION ---

        function goToDailyEntry() {
            const obj = document.getElementById('objectSelect').value;
            const start = document.getElementById('startDate').value;

            if (!obj) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç!"); return; }
            if (!start) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞!"); return; }

            cursorDate = new Date(start);
            renderDailyView();

            document.getElementById('step-setup').classList.remove('active');
            document.getElementById('step-daily').classList.add('active');
        }

        function renderDailyView() {
            // Format Date
            const iso = cursorDate.toISOString().split('T')[0];
            const display = cursorDate.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            document.getElementById('currentDateDisplay').innerText = display;

            renderWorkers();
        }

        function renderWorkers() {
            const container = document.getElementById('workersList');
            container.innerHTML = '';

            workers.forEach((worker, index) => {
                const div = document.createElement('div');
                div.className = 'worker-item';
                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT' && !e.target.classList.contains('remove-btn')) {
                        toggleWorkerSelection(index);
                    }
                };

                // Checkbox
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = worker.selected;
                cb.onchange = () => toggleWorkerSelection(index);

                // Name
                const info = document.createElement('div');
                info.className = 'worker-info';
                info.innerHTML = `<div class="worker-name">${worker.name}</div>`;

                // Hours
                const inp = document.createElement('input');
                inp.type = 'number';
                inp.className = 'hours-input';
                inp.value = worker.hours || 8;
                inp.onchange = (e) => { workers[index].hours = parseFloat(e.target.value); saveWorkersParams(); };
                inp.onclick = (e) => e.stopPropagation();

                div.appendChild(cb);
                div.appendChild(info);
                div.appendChild(inp);

                // Remove btn
                if (worker.id !== 'me') {
                    const del = document.createElement('span');
                    del.className = 'remove-btn';
                    del.innerHTML = '&times;';
                    del.onclick = (e) => { e.stopPropagation(); removeWorker(index); };
                    div.appendChild(del);
                }

                container.appendChild(div);
            });
        }

        function toggleWorkerSelection(index) {
            workers[index].selected = !workers[index].selected;
            saveWorkersParams();
            renderWorkers();
        }

        function addWorker() {
            const name = document.getElementById('newWorkerName').value.trim();
            if (!name) return;
            workers.push({ id: Date.now().toString(), name: name, selected: true, hours: 8 });
            document.getElementById('newWorkerName').value = '';
            saveWorkersParams();
            renderWorkers();
        }

        function removeWorker(index) {
            if (confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                workers.splice(index, 1);
                saveWorkersParams();
                renderWorkers();
            }
        }

        function saveWorkersParams() {
            localStorage.setItem('my_workers_v3', JSON.stringify(workers));
        }

        // --- SUBMISSION LOGIC ---

        function nextDay() {
            // 1. Save current day to buffer
            pushCurrentDayToBuffer();

            // 2. Increment Date
            cursorDate.setDate(cursorDate.getDate() + 1);

            // 3. Re-render
            // Note: We deliberately KEEP the worker's hours/selection states as is, 
            // because the user likely wants to submit the same team/hours for the next day, usually.
            renderDailyView();

            // Feedback
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }

        function pushCurrentDayToBuffer() {
            const selected = workers.filter(w => w.selected);
            if (selected.length === 0) return; // Skip empty days automatically? Or warn? Let's skip.

            const iso = cursorDate.toISOString().split('T')[0];

            savedEntries.push({
                date: iso,
                workers: selected.map(w => ({
                    name: w.name,
                    hours: w.hours || 8
                }))
            });
        }

        function finishAndSend() {
            // Push the FINAL day (current view) if not already pushed
            // But usually "Next" pushes. "Finish" acts as "Submit EVERYTHING up to now including now".
            pushCurrentDayToBuffer();

            if (savedEntries.length === 0) {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏! –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤.");
                return;
            }

            const objectName = document.getElementById('objectSelect').value;

            const payload = {
                type: 'rtb_batch_submission',
                object: objectName,
                entries: savedEntries
            };

            // Local Dev Mode check
            if (!tg.initDataUnsafe || !tg.initDataUnsafe.query_id) {
                console.log("LOCAL_SUBMISSION:", payload);
                alert("üõ† –õ–û–ö–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú\n\n–î–∞–Ω–Ω—ã–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã (—Å–º. –∫–æ–Ω—Å–æ–ª—å):\n" + JSON.stringify(payload, null, 2));
                return;
            }

            try {
                tg.sendData(JSON.stringify(payload));
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
            }
        }

        // Run
        init();
    </script>
</body>

</html>
